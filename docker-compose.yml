services:
  tracker:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY:-hostmaster/crypto-wallet-tracker}:${TAG:-latest}
    platform: linux/x86_64
    build:
      context: .
      dockerfile: Dockerfile
      target: ${TARGET:-runtime}
      args:
        PYTHON_VERSION: ${PYTHON_VERSION:-3.11}
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    volumes:
      - db-data:/data
    secrets:
      - etherscan_api_key
      - tg_bot_token
      - tg_chat_id
      - wallet_address
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  dev:
    extends:
      service: tracker
    build:
      target: development
    volumes:
      - .:/app
      - db-data:/data
    command: ["python", "-m", "debugpy", "--listen", "0.0.0.0:5678", "main.py"]
    ports:
      - "5678:5678"

secrets:
  etherscan_api_key:
    file: ./etherscan_api_key.txt
  tg_bot_token:
    file: ./tg_bot_token.txt
  tg_chat_id:
    file: ./tg_chat_id.txt
  wallet_address:
    file: ./wallet_address.txt

volumes:
  db-data:
    driver: local
